<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/fragment/layout/head :: common_head}"></head>
<body>
<div th:replace="~{/fragment/layout/nav :: common_nav}"></div>
<div class="container" id="main">
    <div class="col-md-12 col-sm-12 col-lg-12">
        <div class="panel panel-default" th:object="${article}">
            <header class="qna-header">
                <h2 class="qna-title" th:text="${article.title}"></h2>
            </header>
            <div class="content-main">
                <article class="article">
                    <div class="article-header">
                        <div class="article-header-thumb">
                            <img src="https://graph.facebook.com/v2.3/100000059371774/picture" class="article-author-thumb" alt="">
                        </div>
                        <div class="article-header-text">
                            <div class="article-author-name" th:text="${article.writer}"></div>
                            <div  class="article-header-time" th:text="${#temporals.format(article.createdAt, 'yy-MM-dd HH:mm')}"></div>
                        </div>
                    </div>
                    <div class="article-doc">
                        <p th:text="${article.contents}"></p>
                    </div>
                    <div class="article-util">
                        <ul class="article-util-list" th:if="${session.loginUser != null && article.userId == session.loginUser.id}">
                            <li>
                                <a class="link-modify-article" th:href="@{/articles/{id}/update-form(id = ${article.id})}">수정</a>
                            </li>
                            <li>
                                <form class="form-delete" action="/questions/423" method="POST">
                                    <input type="hidden" name="_method" value="DELETE">
                                    <button class="link-delete-article" type="submit">삭제</button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </article>
                 <div class="qna-comment">
                      <div class="qna-comment-slipp">
                          <div class="reply-list"></div>
                          <div class="qna-comment-slipp-articles">
                              <form class="submit-write">
                                  <input type="hidden" th:if="${session.loginUser}" id="reply-user-id" th:value="${session.loginUser.id}"/>
                                  <input type="hidden" th:if="${session.loginUser}" id="reply-writer" th:value="${session.loginUser.nickname}"/>
                                  <div class="form-group" style="padding:14px;">
                                      <textarea class="form-control" placeholder="내용을 입력하세요 .." id="reply-comments"></textarea>
                                  </div>
                                  <button class="btn btn-success pull-right" type="button" id="reply-create">답변하기</button>
                                  <div class="clearfix"></div>
                              </form>
                          </div>
                      </div>
                  </div>
            </div>
        </div>
    </div>
</div>
<footer th:replace="~{fragment/layout/footer :: common_footer}"></footer>
<script th:inline="javascript">
    let articleId = [[${article.id}]];
    $(function (e) {
        printReplyList();
    });

    function printReplyList() {
        let url = "/articles/" + articleId + "/replies";
        $.get(url, function (response) {
            let replyListHtml = "";
            let replyList = response.result;

            replyListHtml += `<div className="qna-comment-slipp">
                    <p class="qna-comment-count"><strong>${replyList.length}</strong>개의 의견</p>
                    <div class="qna-comment-slipp-articles">`;

            $(replyList).each(function (idx, reply) {
                replyListHtml += `
                      <article class="article" id="article-${reply.id}">
                          <div class="article-header">
                              <div class="article-header-thumb">
                                  <img src="https://graph.facebook.com/v2.3/1324855987/picture" class="article-author-thumb" alt="">
                              </div>
                              <div class="article-header-text">
                                <div class="article-author-name">&nbsp ${reply.writer}</div>
                                <div class="article-header-time">${reply.createdAt}</div>
                                <div class="article-doc comment-doc">
                                    <p id="reply-comments-${reply.id}">${reply.comments}</p>
                                </div>
                              </div>
                          </div>
                          <div class="article-util">
                              <ul class="article-util-list">
                                  <li>
                                        <button class="update-answer-button" type="button" id="reply-update-button" data-reply-id="${reply.id}">수정</button>
                                  </li>
                                  <li>
                                      <form class="delete-answer-form" action="/questions/413/answers/1405" method="POST">
                                          <input type="hidden" name="_method" value="DELETE">
                                          <button type="submit" class="delete-answer-button">삭제</button>
                                      </form>
                                  </li>
                              </ul>
                          </div>
                      </article>
                `;
            });
            $(".reply-list").html(replyListHtml);
        })
    }

    $("button#reply-create").click( function (e) {
        e.preventDefault();
        if (!document.querySelector("#reply-user-id")) {
            alert("로그인을 먼저 해주세요.");
            return;
        }
        if (!document.querySelector("#reply-comments")) {
            alert("내용을 입력해주세요.");
            return;
        }

        let sendReplyData = {
            "articleId" : articleId,
            "userId" : document.querySelector("#reply-user-id").value,
            "writer" : document.querySelector("#reply-writer").value,
            "comments" : document.querySelector("#reply-comments").value
        };
        $.ajax({
            type: "POST",
            url: "/articles/" + articleId + "/replies",
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(sendReplyData),
            success: function (response) {
                document.getElementById("reply-comments").value = "";
                printReplyList();
            },
            error: function (err) {
                console.log(sendReplyData);
                alert("댓글 작성 오류");
            }
        });
    });

    $(document).on('click', '#reply-update-button', function (e) {
        e.preventDefault();
        const replyId = $(this).data('reply-id');
        const comments = $(`#reply-comments-${replyId}`).text().trim();

        const editForm = `
          <div class="qna-comment">
            <div class="qna-comment-slipp">
                <div class="qna-comment-slipp-articles">
                    <form class="reply-update-form" style="padding:14px;">
                        <input type="hidden" id="reply-id" value="${replyId}"/>
                        <div class="form-group" style="padding:14px;">
                            <textarea class="form-control" id="reply-comments">${comments}</textarea>
                        </div>
                        <button class="btn btn-success pull-right" type="submit" id="reply-update-success">수정 완료</button>
                        <div class="clearfix"></div>
                    </form>
                </div>
            </div>
        </div>
        `;
        $(`#article-${replyId}`).replaceWith(editForm);
    });

    $(document).on('submit', '.reply-update-form', function(e) {
        e.preventDefault();
        console.log("------------- test -------------");
        const replyId = $('#reply-id').val();
        const updatedComment = $('#reply-comments').val();

        let replyUpdateDto = {
            "id" : replyId,
            "comments" : updatedComment
        };

        $.ajax({
            url: "/articles/" + articleId + "/replies/" + replyId,
            type: 'PUT',
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(replyUpdateDto),
            success: function(response) {
                if (!response.success) {
                    alert(response.result);
                }
                printReplyList();
            },
            error: function() {
                alert("댓글 수정 실패");
            }
        });
    });
</script>
</body>
</html>